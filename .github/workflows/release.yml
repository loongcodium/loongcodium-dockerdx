name: Release


on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      extension_version:
        description: 'Docker extension version to build (e.g., v1.1.4). If empty, the latest upstream version will be used after checking for updates.'
        required: false
        default: ''
      release_version:
        description: 'The version to use in release (e.g., v1.1.4-1). If empty, the release workflow will not be triggered.'
        required: false
        default: ''


jobs:
  determine_version:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      docker_language_server_version: ${{ steps.version_logic.outputs.docker_language_server_version }}
      docker_vscode_extension_version: ${{ steps.version_logic.outputs.docker_vscode_extension_version }}
      release_version: ${{ steps.version_logic.outputs.release_version }}
      should_build: ${{ steps.version_logic.outputs.should_build }}
    steps:
      - name: Determine version and whether to build
        id: version_logic
        run: |
          if [ -n "${{ github.event.inputs.extension_version }}" ]; then
            echo "Building specified versions"
            echo "should_build=true" >> $GITHUB_OUTPUT
            EXT_VERSION="${{ github.event.inputs.extension_version }}"
            LS_VERSION=v$(curl -s "https://raw.githubusercontent.com/docker/vscode-extension/refs/tags/$EXT_VERSION/build/downloader.mjs" | sed -n "s/.*const version = '\(.*\)';/\1/p")
            echo "docker_language_server_version=$LS_VERSION" >> $GITHUB_OUTPUT
            echo "docker_vscode_extension_version=$EXT_VERSION" >> $GITHUB_OUTPUT
            echo "release_version=${{ github.event.inputs.release_version }}" >> $GITHUB_OUTPUT
          else
            echo "Checking for newer upstream versions..."
            sudo apt-get update && sudo apt-get install -y jq
            
            EXT_UPSTREAM=$(curl -s https://api.github.com/repos/docker/vscode-extension/releases/latest | jq -r .tag_name)
            LS_UPSTREAM=v$(curl -s "https://raw.githubusercontent.com/docker/vscode-extension/refs/tags/$EXT_UPSTREAM/build/downloader.mjs" | sed -n "s/.*const version = '\(.*\)';/\1/p")
            OWN_VERSION=$(curl -sL https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name || echo "v0.0.0")
            
            echo "Language Server upstream version: $LS_UPSTREAM"
            echo "Extension upstream version: $EXT_UPSTREAM"
            echo "Own version: $OWN_VERSION"
            
            EXT_UPSTREAM_NUM=${EXT_UPSTREAM#v}
            OWN_VERSION_NUM=${OWN_VERSION#v}
            
            if dpkg --compare-versions "$EXT_UPSTREAM_NUM" "gt" "$OWN_VERSION_NUM"; then
              echo "Newer upstream version found: $EXT_UPSTREAM"
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "docker_language_server_version=$LS_UPSTREAM" >> $GITHUB_OUTPUT
              echo "docker_vscode_extension_version=$EXT_UPSTREAM" >> $GITHUB_OUTPUT
              echo "release_version=$EXT_UPSTREAM" >> $GITHUB_OUTPUT
            else
              echo "No newer upstream version found."
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "docker_language_server_version=" >> $GITHUB_OUTPUT
              echo "docker_vscode_extension_version=" >> $GITHUB_OUTPUT
              echo "release_version=" >> $GITHUB_OUTPUT
            fi
          fi


  build_docker_language_server:
    runs-on: ubuntu-latest
    needs: determine_version
    if: needs.determine_version.outputs.should_build == 'true'

    strategy:
      matrix:
        os: [linux]
        arch: [loong64]
        include:
          - os: linux
            ext: ""

    steps:
      - uses: actions/checkout@v4
        with:
          repository: docker/docker-language-server
          ref: ${{ needs.determine_version.outputs.docker_language_server_version }}

      - name: Checkout patches
        uses: actions/checkout@v4
        with:
          path: patches-repo

      - name: Apply panicwrap patch for loong64
        run: |
          if [ "${{ matrix.arch }}" = "loong64" ]; then
            go mod vendor
            patch -p1 -d vendor/github.com/bugsnag/panicwrap < patches-repo/patches/panicwrap-dup2-loong64.patch
          fi

      - name: Build for ${{ matrix.os }}-${{ matrix.arch }}
        run: make build
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}

      - name: Rename the binary to include the version number
        run: |
          mv docker-language-server-${{ matrix.os }}-${{ matrix.arch }} docker-language-server-${{ matrix.os }}-${{ matrix.arch }}-${{ needs.determine_version.outputs.docker_language_server_version }}

      - uses: actions/upload-artifact@v4
        with:
          name: docker-language-server-${{ matrix.os }}-${{ matrix.arch }}-${{ needs.determine_version.outputs.docker_language_server_version }}${{ matrix.ext }}
          path: docker-language-server-${{ matrix.os }}-${{ matrix.arch }}-${{ needs.determine_version.outputs.docker_language_server_version }}${{ matrix.ext }}
          if-no-files-found: error


  build_docker_vscode_extention:
    runs-on: ubuntu-latest
    needs: [determine_version, build_docker_language_server]
    if: needs.determine_version.outputs.should_build == 'true'

    strategy:
      matrix:
        os: [linux]
        nodearch: [loong64]
        include:
          - os: linux
            nodeos: linux
            ext: ''

    steps:
      - uses: actions/checkout@v4
        with:
          repository: docker/vscode-extension
          ref: ${{ needs.determine_version.outputs.docker_vscode_extension_version }}

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Patch metadata
        run: |
          cat package.json | \
          jq '.displayName=(.displayName) + " (loong64)"' | \
          jq '.description=(.description) + " (This version is for LoongArch64 only)"' | \
          jq '.version=("${{ needs.determine_version.outputs.release_version }}"|ltrimstr("v"))' | \
          jq '.publisher="loong-vsx"' | \
          jq '.homepage="https://github.com/loongcodium/dockerdx-loong64"' | \
          jq '.repository.url="https://github.com/loongcodium/dockerdx-loong64.git"' | \
          jq '.bugs.url="https://github.com/loongcodium/dockerdx-loong64/issues"' \
          > tmp.json && mv -v tmp.json package.json

      - run: |
          NODE_OS=${{ matrix.nodeos }} NODE_ARCH=${{ matrix.nodearch }} npm install
        
      - name: Set variables
        id: set-variables
        run: |
          VERSION=$(npm pkg get version | tr -d \")
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

          SHA=$(git rev-parse --short HEAD)
          echo "SHA=$SHA" >> "$GITHUB_OUTPUT"

      - name: Build the extension
        env:
          VERSION: ${{ steps.set-variables.outputs.VERSION }}
          SHA: ${{ steps.set-variables.outputs.SHA }}
        run: |
          npm install -g @vscode/vsce
          vsce package -o docker-vscode-extension-${{ matrix.os }}-${{ matrix.nodearch }}-$VERSION-$SHA.vsix

      - uses: actions/upload-artifact@v4
        with:
          name: docker-vscode-extension-${{ matrix.os }}-${{ matrix.nodearch }}-${{ steps.set-variables.outputs.VERSION }}-${{ steps.set-variables.outputs.SHA }}.vsix
          path: docker-vscode-extension-${{ matrix.os }}-${{ matrix.nodearch }}-${{ steps.set-variables.outputs.VERSION }}-${{ steps.set-variables.outputs.SHA }}.vsix
          if-no-files-found: error


  release:
    name: release
    runs-on: ubuntu-latest
    needs: [determine_version, build_docker_language_server, build_docker_vscode_extention]
    if: needs.determine_version.outputs.should_build == 'true' && needs.determine_version.outputs.release_version
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Tag version
        run: |
          git tag ${{ needs.determine_version.outputs.release_version }}
          git push origin ${{ needs.determine_version.outputs.release_version }}
      - uses: actions/download-artifact@v5
        with:
          merge-multiple: true
      - run: ls -al

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine_version.outputs.release_version }}
          files: |
            ./**/*.vsix
            ./**/*docker-language-server*

      - name: Install ovsx
        run: npm install --global ovsx
      - name: Publish extension
        run: ovsx publish ./*.vsix
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
